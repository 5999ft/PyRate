[![Build Status](https://travis-ci.org/GeoscienceAustralia/PyRate.svg?branch=master)](https://travis-ci.org/GeoscienceAustralia/PyRate)
[![Code](https://coveralls.io/repos/github/geoscienceaustralia/pyrate/badge.svg?branch=master)](https://coveralls.io/github/geoscienceaustralia/pyrate?branch=master)
[![Updates](https://pyup.io/repos/github/geoscienceaustralia/pyrate/shield.svg)](https://pyup.io/repos/github/geoscienceaustralia/pyrate/)
[![Python 3](https://pyup.io/repos/github/geoscienceaustralia/pyrate/python-3-shield.svg)](https://pyup.io/repos/github/geoscienceaustralia/pyrate/)
   
   
# PyRate - a Python tool for RAte and Time-series Estimation

PyRate is a Python tool for estimating the average rate (velocity) and incremental time-series of surface movement for every pixel in a stack of images generated by interferometric processing of Synthetic Aperture Radar (InSAR) data. PyRate is a partial Python translation of [Pirate](http://homepages.see.leeds.ac.uk/~earhw/software/pirate/), a MATLAB tool developed at the University of Leeds.

## Contributions:

PyRate has been developed by [Geoscience Australia](http://www.ga.gov.au) and the [National Computational Infrastructure](http://nci.org.au/). The following people have contributed to the code development:

- Sudipta Basak
- Ben Davies
- Matt Garthwaite
- Simon Knapp
- Negin Moghaddam
- Vanessa Newey
- Garrick Paskos

## Contact:

Questions or feedback about the PyRate software can be directed to [insar@ga.gov.au](mailto:insar@ga.gov.au).

## Licencing:

TODO

## Dependencies:

- [SciPy](www.scipy.org)
- [GDAL](www.gdal.org)
- [NetworkX](https://pypi.python.org/pypi/networkx)
- [pyproj](https://pypi.python.org/pypi/pyproj)
- [nose](https://pypi.python.org/pypi/nose/)
- [pytest](https://pypi.python.org/pypi/pytest)
- [sphinx](http://sphinx-doc.org/) for building the docs.
- [luigi](https://pypi.python.org/pypi/luigi) for controlling batch jobs.
- [parmap](https://pypi.python.org/pypi/parmap/1.2.0) a python multiprocessing wrapper.

For the viewer you will also need

- [Flask](http://flask.pocoo.org/)
- [Pillow](https://pypi.python.org/pypi/Pillow)
- [netCDF4](https://pypi.python.org/pypi/netCDF4)
- a web browser.

## Clone the repo:

Clone the repo:    

    git clone https://github.com/GeoscienceAustralia/PyRate.git
    
This will prompt for your github username and password. Once you have entered them and you have access to this repo, `PyRate` will clone in your current directory. 

## Virtualenv setup for `PyRate`

It is recommended that you create a `virtualenv` to run the `PyRate` code. 

These instructions are for `ubuntu 14.04` and is expected to work for most newer versions of `ubuntu`. The `virtualenv` and the requirements can be installed using the following steps.

    sudo apt-get install python-pip
    sudo pip install -U pip  # bings the latest pip
    sudo pip install virtualenv # then enter your root password
    sudo apt-get -y --force-yes build-dep matplotlib
    sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable && sudo apt-get update
    sudo apt-get install -y --force-yes gdal-bin python-gdal libgdal-doc libgdal-dev
    virtualenv -p python2.7 ~/pyrate_venv
    source ~/pyrate_venv/bin/activate

Note, in the above, the first command `sudo apt-get -y build-dep matplotlib` installs all the build dependencies for `matplotlib`.

Once inside the `virtualenv`, navigate to the `PyRate` code:
    
    cd PyRate # This is where the requirements.txt exists
    pip install -r requirements.txt
    pip install GDAL==$(gdal-config --version) --global-option=build_ext --global-option="-I/usr/include/gdal"    

Then proceed to test `PyRate`. The above assumes that your system gdal header files can be found in the default `/usr/include/gdal` directory, otherwise you have to provide `gdal` path to pip to be able to install `gdal`.

`pip install GDAL==$(gdal-config --version) --global-option=build_ext --global-option="-I/usr/include/gdal"` command works for most versions of gdal, except `version 1.11.3` which unfortunately is still the default version of gdal in ubuntu 16.04 (i.e., `sudo apt-get install gdal-bin` in ubuntu 16.04 install `version 1.11.3`). This is becasue pip does not have bindings for this version. To get around this you will need to download and [install gdal from source](http://download.osgeo.org/gdal/) and then use the same commands.

## Anaconda setup for `PyRate`

####  Install anaconda:

On 64bit linux:
    
    bash Anaconda2-2.4.1-Linux-x86_64.sh

Please accept all defaults. This will install anaconda in the `~/anaconda2` directory.
 
You will need to download and install the appropriate version for your OS. The following instructions are for ubuntu 14.04 and are exptect to work for most versions of ubuntu.

#### Activate `anaconda` and install `conda-env`

    source ~/anaconda2/bin/activate anaconda2/
    conda install -c conda conda-env        

The `conda-env` package enables `yml` based `virtualenv` installation.

#### Create the `pyrate` environment
    
    conda env create -f /path/to/PyRate/environment.yml
    
#### Activate the `pyrate` environment

    source ~/anaconda2/bin/activate pyrate
    
#### Run `PyRate` tests

To run the tests, use the following command inside the `PyRate` directory:
		
	cd PyRate
	nosetests --nologcapture    
    
#### Back to main anaconda if you need to:
    
    source activate /home/user/anaconda2
    
#### Deactivate
Once you are done using `PyRate` you could deactivate from the conda env using: 

    source deactivate

    
## Setting up the 'PYRATEPATH' environment variable

You need to add the directory containing the `pyrate` folder to the *PYTHONPATH* environment variable.

The environment variable *PYRATEPATH* needs to point to the folder where you put the test data. This is how I set up my environment variable:

	export PYRATEPATH="/home/sudipta/GA/PyRate"
	export PYTHONPATH=$PYRATEPATH/:$PYTHONPATH


## `rhe-compute1` anaconda instructions

For anaconda installation and `virtualenv` instruction, [see this guide] (rhe_compute.md).   
  
	
## Documentation

The [Sphinx](http://sphinx-doc.org/) documenation of the scripts can be found under the main documentation tree for the project, which is found in the top level folder *doc*. To build the documentation do

	apidoc
	make html

The documentation will be generated in *doc/build*. The main entry point is *index.html*.


## Tests

Tests use [unittest](http://pythontesting.net/framework/unittest/unittest-introduction/) and can be found in *pyrate/tests*.

To run the tests, use the following command inside the `PyRate` directory:
		
	cd PyRate
	nosetests --nologcapture
	
Or you can use `unittest discover`:

	cd PyRate
	python -m unittest discover pyrate/

## Basic Usage Instructions

The runnable programs can be found in *pyrate/scripts*.

The steps are:

1. Edit the config file
1. Data formatting
1. Image transformations
1. PyRate workflow

### Config file:

TODO

### Data formatting:

The utility script *converttogtif.py* is provided to convert geocoded unwrapped interferograms in ROI_PAC or GAMMA format into a GeoTIFF format usable by PyRate.

	python <full_path>/converttogtif.py <CONFIG_FILE>

The script will determine the input format from the value specified at the *processor:* keyword in the config file (0: ROI\_PAC; 1: GAMMA)

A GAMMA translation requires a geographic DEM header file (\*.dem.par) and SLC parameter files (\*.slc.par) for both master and slave images to extract metadata required for the formatting. Therefore three header files are needed to format each geocoded unwrapped GAMMA interferogram <GAMMA_FILE>. The path and name of the DEM header file are specified in the config file under the *demHeaderFile:* keyword. The SLC parameter files should be in the same location as the interferogram file and are found automatically by date string pattern matching.

A ROI\_PAC translation requires a header/resource file (*.rsc* extension) for the geocoded unwrapped ROI_PAC interferogram (in the same directory) and either the geographic projection (e.g. 'WGS84') specified as an option or a header/resource file for the geographic DEM containing the geographic projection in the parameter DATUM:


### PyRate workflow:

#### Image transformations: run_prepifg.py
This separate step of multi-looking (resampling) and cropping the images is handled with *run_prepifg.py*.
 
To convert the unwrapped interferrograms, use the `run_prepifg` module. Once `PYRATEPATH` has been setup, and you are in the `pyrate` `virtualenv`, you can use `pyrate.conf` to process `roipac`/`gamma` format interferrograms into `.tif` files for time series and linear rate analyssis using `run_pyrate`. So the first step is to run `run_prepifg` is the following:
    
    cd PyRate
	python <full_path>/run_prepifg.py -h (for command line options/help)
    python <full_path>/run_prepifg.py pyrate.conf (like python pyrate/scripts/run_prepifg.py pyrate.conf, you will need to update the data paths in the config file)
     
Two examples of the config files are provided in `pirate.conf` and `pyrate_gamma.conf`, showing respectively the `roipac` and `gamma` prepifg configuration. Both config files can be used with `run_pyrate.py`.  
 
#### Time series analysis: run_pyrate.py

This is the core of the processing tools, handled with run_pyrate.py.

This is how one can use `run_pyrate.py`:
    
    cd PyRate
	python <full_path>/run_pyrate.py -h  (for command line options/help) 
	python <full_path>/run_pyrate.py (this will use the default pyrate.conf from the PyRate folder, you will need to update the data paths in the config file)
	python pyrate/scripts/run_pyrate.py (uses default pyrate.conf from current folder)
	python pyrate/scripts/run_pyrate.py my_config.conf (uses my_config.conf)

### Running the viewer

You run the viewer from *pyrate/viewer/web.py" and passing the directory containing the (geotif) files you want to look at as the first command line parameter. For example:

	python pyrate/viewer/web.py /path/to/tifs

The program looks for a file *test.ncdf* (specified by `pyrate.viewer.datamanager.IMAGE_STACK_FILE_NAME`) in */path/to/tifs* and if it cannot find it, it will create it from all the files with the tif extension in that directory. It will create (or overwrite) the file *na_frequency.png* at the same time.

These two files will remain once the program exits and **WILL NOT BE AUTOMATICALLY RECREATED IF THE TIFF FILES CHANGE**. That is, one must manually remove *test.ncdf* to cause recreation of it.

## Integrating PyAPS with PyRate

Inside the `PyRate` top-level directory, clone the [PyAPS package from this Geoscience Austalia github repo](https://github.com/GeoscienceAustralia/PyAPS.git) .

Follow the instructions in the [PyAPS README file] (https://github.com/GeoscienceAustralia/PyAPS/blob/master/README.md)

Export PyAPS repo location to *PYTHONPATH* environment variable:

    export PYTHONPATH=/path/to/PyRate/PyAPS:$PYTHONPATH

Create an `ECMWF` directory within the top-level directory of the `PyRate` repo

    cd PyRate
    mkdir ECMWF

This is where the model data files in `grib` format will be saved after download from the ECMWF server.

Run the `remove_aps_delay.py` script from the 'PyRate' directory

    cd PyRate
    python pyrate/remove_aps_delay.py

