<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Running PyRate on a HPC system &#8212; PyRate  documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Usage" href="usage.html" />
    <link rel="prev" title="Installation" href="installation.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="running-pyrate-on-a-hpc-system">
<h1>Running PyRate on a HPC system<a class="headerlink" href="#running-pyrate-on-a-hpc-system" title="Permalink to this headline">¶</a></h1>
<p>This README is a quick guide to getting the PyRate software up and
running in a Portable Batch System (PBS) batch environment with MPI
support. This setup is common in High Performance Compute (HPC) systems
such as the National Computational Infrastructure&#8217;s <a class="reference external" href="http://nci.org.au/systems-services/national-facility/peak-system/raijin/">Raijin</a>
system.</p>
<p>The instructions below are tailored to the NCI Raijin system. Some
instructions may not be applicable depending on the setup of the HPC
system you are using. They should apply to both single-node and
multi-node jobs; just set the number of cpus in the PBS directives in
the job submission script accordingly (e.g. ncpus=32 for 2 nodes).</p>
<p>These instructions assume you are using bash shell.</p>
<div class="section" id="pre-installation">
<h2>Pre-installation<a class="headerlink" href="#pre-installation" title="Permalink to this headline">¶</a></h2>
<p>These instructions currently only work with gcc and not the Intel
compilers.</p>
<ol class="arabic">
<li><p class="first">Clone the <code class="docutils literal"><span class="pre">PyRate</span></code> repository into your home directory, or some
other directory of your choice:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ cd ~
$ git clone git@github.com:GeoscienceAustralia/PyRate.git
</pre></div>
</div>
</li>
<li><p class="first">Unload the icc compiler and default openmpi from the terminal:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ module unload intel-cc
$ module unload intel-fc
$ module unload openmpi
</pre></div>
</div>
</li>
<li><p class="first">Load the modules required for installation and running:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ module load python3/3.4.3 python3/3.4.3-matplotlib
$ module load hdf5/1.8.10 gdal/2.0.0 openmpi/1.8 netcdf/4.3.2
</pre></div>
</div>
<p>(Alternatively, you may wish to add the above lines to your
~/.profile)</p>
</li>
<li><p class="first">Now add the following lines to the end of your ~/.profile:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>export PATH=$HOME/.local/bin:$PATH
export PYTHONPATH=$HOME/.local/lib/python3.4/site-packages:$PYTHONPATH
export PYRATEPATH=~/PyRate
export VIRTUALENVWRAPPER_PYTHON=/apps/python3/3.4.3/bin/python3
export LC_ALL=en_AU.UTF-8
export LANG=en_AU.UTF-8
source $HOME/.local/bin/virtualenvwrapper.sh
</pre></div>
</div>
</li>
<li><p class="first">Install virtualenv and <code class="docutils literal"><span class="pre">virtualenvwrapper</span></code> by running the following
command on the terminal:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ pip3 install  --user virtualenv virtualenvwrapper
</pre></div>
</div>
</li>
<li><p class="first">Refresh your environment by reloading your profile:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ source ~/.profile
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Create a new virtualenv for PyRate:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ mkvirtualenv --system-site-packages pyrate
</pre></div>
</div>
</li>
<li><p class="first">Make sure the virtualenv is activated:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ workon pyrate
</pre></div>
</div>
</li>
<li><p class="first">Install <code class="docutils literal"><span class="pre">pyrate</span></code>:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ cd $PYRATEPATH
$ pip install python-daemon==2.1.1  # the latest python-daemon had
$ python setup.py install
</pre></div>
</div>
</li>
<li><p class="first">Once installation has completed, you can run the tests to verify
everything has gone correctly:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ pip install pytest
$ py.test ~/PyRate/tests/
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="updating-the-code">
<h2>Updating the Code<a class="headerlink" href="#updating-the-code" title="Permalink to this headline">¶</a></h2>
<p>To update the code, first make sure you are in the <code class="docutils literal"><span class="pre">pyrate</span></code> virtual
environment:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ workon pyrate
</pre></div>
</div>
<p>Next, pull the latest commit from the master branch, and install:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ cd $PYRATEPATH
$ git pull origin
$ python setup.py install
</pre></div>
</div>
<p>If the pull and the installation complete successfully, the code is
ready to run!</p>
</div>
<div class="section" id="running-batch-jobs">
<h2>Running Batch Jobs<a class="headerlink" href="#running-batch-jobs" title="Permalink to this headline">¶</a></h2>
<p>in the <code class="docutils literal"><span class="pre">pbs</span></code> subfolder of the <code class="docutils literal"><span class="pre">PyRate</span></code> repo there are some example
scripts to assist launching batch jobs over multiple nodes with PBS.</p>
<div class="section" id="batch-testing">
<h3>Batch testing<a class="headerlink" href="#batch-testing" title="Permalink to this headline">¶</a></h3>
<p>To check everything is working, submit the tests as a batch job:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ cd $PYRATEPATH/pbs
$ qsub submit_tests.sh
</pre></div>
</div>
</div>
<div class="section" id="mpirun">
<h3>MPIRun<a class="headerlink" href="#mpirun" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">PyRate</span></code> uses MPI internally for parallelization. To run a script or
demo simply do:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ mpirun -n &lt;num_procs&gt; &lt;command&gt;
</pre></div>
</div>
<p>For example:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ mpirun -n 16 pyrate prepifg pyrate_pbs.conf
</pre></div>
</div>
<p>A PBS job submission script might look like this:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
#PBS -P &lt;project&gt;
#PBS -q &lt;queue&gt;
#PBS -l walltime=01:00:00,mem=128GB,ncpus=16,jobfs=20GB
#PBS -l wd

# setup environment
module unload intel-cc
module unload intel-fc
module load python3/3.4.3 python3/3.4.3-matplotlib
module load load hdf5/1.8.10 gdal/2.0.0
source $HOME/.profile

# start the virtualenv
workon pyrate

# run PyRate commands
mpirun -n 16 pyrate prepifg /path/to/config_file.conf
mpirun -n 16 pyrate linrate /path/to/config_file.conf
mpirun -n 16 pyrate postprocess /path/to/config_file.conf
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Running PyRate on a HPC system</a><ul>
<li><a class="reference internal" href="#pre-installation">Pre-installation</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#updating-the-code">Updating the Code</a></li>
<li><a class="reference internal" href="#running-batch-jobs">Running Batch Jobs</a><ul>
<li><a class="reference internal" href="#batch-testing">Batch testing</a></li>
<li><a class="reference internal" href="#mpirun">MPIRun</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="installation.html" title="previous chapter">Installation</a></li>
      <li>Next: <a href="usage.html" title="next chapter">Usage</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/pbs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Geoscience Australia InSAR team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/pbs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>